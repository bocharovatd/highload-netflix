# Проектирование высоконагруженного сервиса Netflix

## Содержание:
1. [Тема и целевая аудитория](#1)

## 1. Тема и целевая аудитория:
Netflix - стриминговый сервис для просмотра фильмов и сериалов.

### Функционал MVP
- регистрация и авторизация пользователей
- просмотр фильмов и сериалов в режиме стриминга
- полнотекстовый поиск по названию, жанру, актерам и режиссеру
- добавления фильмов и сериалов в избранное
- история просмотров
- система рекомендаций (общая, по событиям, на основе начатых просмотров, потребленного контента)
- push-уведомления о выходе новых сериалов и серий просмотренных сериалов

### Целевая аудитория

#### Анализ трафика
- количество уникальных пользователей в день (DAU) - 67.5M [^1]
- количество уникальных пользователей в месяц (MAU) - 2B [^1]
- среднее время просмотра стримов в день в первой четверти 2024 (daily time spent streaming) - 2 hours [^2]

 #### Трафик по странам [^4]
- основное географическое положение аудитории - США

![Geography](images/geography.png)

#### Количество позиций в библиотеке по странам [^3]
| Country    | Titles | 
| ---------- | ------ | 
| US         | 7427   |
| Australia  | 7711   |
| Canada     | 7626   |
| UK         | 8691   |

#### Подписчики [^5]
- подписчиков на последнюю четверть 2024 года - 282.7M
- новых подписчиков за 2024 год - 22.7M (282.7M - 260.28M)

## 2. Расчет нагрузки:

### Продуктовые метрики
- #### MAU = 271M*
- #### DAU  = 48.8M*

*В ранее приведенной статистике DAU и MAU учитываются только посещения сайта netflix.com, причем bounce rate, 
т.е. количество пользователей, которые которые покидают сайт после просмотра одной страницы, равно 42.88%.
Следовательно, эти данные не репрезентативны для подсчета выполнения целевых действий. 
За основу расчета DAU и MAU возьму MAU пользователей приложением в 2022 году 106M + 115M = 221M [^6]. 
C 2022 года сервис вырос с 230.7M подписчиков до 282.7M, т.е. на 22.54%.
Если считать, что темпы сервиса за этот период - 22.54%, то за два года MAU увеличилось бы до 271M. 
Нормальный sticky factor для сервисов с видеостримингом - 18%. Расситаем DAU = 0.18 * 271M  = 48.8M.

- #### зарегистрированных пользователей - 300M

- #### средний размер хранилища пользователя

| Тип данных | Средний размер единицы данных | Количество данных на пользователя | Суммарный размер данных |
| ---------- | ----------------------------- | --------------------------------- | ----------------------- |
| Данные о профиле (логин, email, хэш пароля) | 1 КБ | 1 | 1 КБ |
| Избранное | 0.1 КБ (ID контента) * 50 = 5 КБ | 1 | 5 КБ |
| История просмотров | 0.2 КБ (ID контента + timestamp) * 150 = 30 КБ | 1 | 30 КБ |
| Рекомендации | 30 КБ (векторы рекомендаций) | 1 | 30 КБ |
| Push-уведомления | 0.5 КБ * 30 = 15 КБ | 1 | 15 КБ |

Итого: 1 + 5 + 30 + 30 + 15 = 81 КБ 

- #### среднее количество действий пользователя по типам в день

| Наименование действия | Расчет количества дейсвий в день | Результат |
| --- | --- | --- |
| регистрация на сайте | Рост подписчиков за год составил 22.7M / 282.7M = 8%, т.е. 0.02% в день | 0.02 |
| просмотр видео | Поскольку пользователи проводят на сайте 2 часа в день, а в среднем контент длится 45 минут, то пользователь успевает сделать 2.6 запроса на просмотр видео | 2.6 |
| поиск | Для поиска в качестве среднего значения возьмем 1, поскольку в netflix часть задач поиска берет на себя сиситема рекомендаций, а среднее количество поисковых запросов не должно превышать просмотры видео | 1 |
| добавление в избранное | Более редкое действие, чем обращение к истории просмотров | 0.5 |
| обращение к истории просмотров | Считаем, что история являеся базовой функцией и 100% пользователей ее используют | 1 |
| просмотр уведомлений | За два часа пользователь не успеет посмотреть много уведомлений, но за день посещения в ему должно прийти хотя бы одно уведомление | 1.5 |

### Технические метрики

- #### Размер хранения в разбивке по типам данных
С учетом статистики по размеру библиотеки netflix в разных странах [^3] с запасом будем считать, что общее количество хранимого контента - 9000 шт. За среднюю продолжительность единицы (шт.) контента возьмем 5 часов.

В облачных хранилищах нетфликс хранятся 2 типа контента: *оригинальное видео* и *закодированные видео* (для быстрой отдачи контента в разных  форматах, с разными аудиодорожками и т.д.) Допустим, всего неоходимо хранить 100 закодированных файлов для одной единицы контента.

<u>Рассчитаем размер единицы контента оригинального видео</u><br>
Раздача видео потребляет для low - 0.3 Гб, medium - 0.7 Гб, SD - 1 Гб, HD - 3 Гб, Ultra HD - 7 Гб.[^7]
Если считать, что кодеки сжимают видео в 50 раз, то размер исходного файла составляет 7 Гб * 50 * 5 часов = 1750 Гб.
Каждый такой оригинальный файл хранится в 3 экземплярах [^8].

<u>Рассчитаем размер единицы контента закодированного видео</u><br>
Средний размер = (0.3 Гб + 0.7 Гб + 1 Гб + 3 Гб + 7 Гб) / 5 * 5 часов = 12 Гб.

<u>Итого</u><br>
| Тип данных | Размер единицы | Количество единиц | Размер в Тб |
| --- | --- | --- | --- |
| оригинальные видео | 1750 Гб | 27_000 (3 * 9000) | 46_143 Тб |
| закодированные видео | 12 Гб | 900_000 (100 * 9000) | 10_547 Тб |
| пользовательские данные | 81 Кб | 282.7M | 22_362 Тб |
Итого: 46_143 + 10_547 + 22_362 = 79_052 Тб 

- #### Сетевой трафик

Prime time для просмoтора  ТV-шоу в среднем приходится на промежуток 20.00 - 23.00, то есть чтобы определить пиковую нагрузку нужно посмотреть, у каких стран с наибольшим количеством зрителей может пересечься prime-time (разница во времени в странах составляем менее 3-х часов). Это США, Канада и Бразилия, т.е. примерно 30% всех пользователей. Будем считать, что в пиковый час нагрузки сервисом совершаются 35% действий.
Тогда 0.35 * DAU * количество действий в день - количество действий в пиковый час.
| Наименование действия | Расчет | Пиковое потребление в течение суток |
| --- | --- | --- |
| регистрация на сайте | (0.35 * 48.8M * 0.02) * 1 Кб / 3600 * 8 | 0.0008 Гбит/сек |
| просмотр видео | (0.35 * 48.8M * 2.6) * (12 Гб / 5 * 0.75 * 1024 * 1024)Кб (размер 45 минут закодированного видео) / 3600 * 8 | 186_260.67 Гбит/сек |
| поиск | (0.35 * 48.8M * 1) * 1024 Кб / 3600 * 8 | 38.87 Гбит/сек |
| добавление в избранное | (0.35 * 48.8M * 0.5) * 0.2 Кб / 3600 * 8 | 0.0038 Гбит/сек |
| обращение к истории просмотров | (0.35 * 48.8M * 1) * 1024 Кб / 3600 * 8 | 38.87 Гбит/сек |
| просмотр уведомлений | (0.35 * 48.8M * 1.5) * 15 КБ / 3600 * 8 | 0.85 Гбит/сек |
Итого: 0.0008 + 186_260.67 + 38.87 + 0.0038 + 38.87 + 0.85 = 186_339.2646 Гбит/сек

| Наименование действия | Расчет | Суммарный суточный трафик |
| --- | --- | --- |
| регистрация на сайте | 48.8M * 0.02 * 1Кб / (1024 * 1024) | 1 Гбайт/сутки |
| просмотр видео | 48.8М * 2.6 * (12 Гб / 5 * 0.75 * 1024 * 1024)Кб (размер 45 минут закодированного видео) / (1024 * 1024) | 228_384_024 Гбайт/сутки |
| поиск | 48.8М * 1 * 1024 Кб / (1024 * 1024) | 47_656 Гбайт/сутки |
| добавление в избранное | 48.8М * 0.5 * 0.2 Кб / (1024 * 1024) | 5 Гбайт/сутки |
| обращение к истории просмотров | 48.8М * 1 * 1024 Кб / (1024 * 1024) | 47_656 Гбайт/сутки |
| просмотр уведомлений | 48.8М * 1.5 * 15 КБ / (1024 * 1024) | 1047 Гбайт/сутки |
Итого: 1 + 228_384_024 + 47_656 + 5 + 47_656 + 1047 = 228_480_389 Гбайт/cутки

- #### RPS в разбивке по типам запросов 
DAU * количество действий в день / 86_400 - средний RPS<br>
0.35 * DAU * количество действий в день / 3600 - пиковый RPS

| Наименование действия | Расчет среднего RPS | Средний RPS | Расчет пикового RPS | Пиковый RPS |
| --- | --- | --- | --- | --- |
| регистрация на сайте | 48.8M * 0.02 / 86_400 | 11 | 0.35 * 48.8M * 0.02 / 3600 | 366 |
| просмотр видео | 48.8М * 2.6 / 86_400 | 1469 | 0.35 * 48.8М * 2.6 / 3600 | 47_580 |
| поиск | 48.8М * 1 / 86_400 | 565 | 0.35 * 48.8М * 1 / 3600 | 18_300 |
| добавление в избранное | 48.8М * 0.5 / 86_400 | 282 | 0.35 * 48.8М * 0.5 / 3600 | 9150 |
| обращение к истории просмотров | 48.8М * 1 / 86_400 | 565 | 0.35 * 48.8М * 1 / 3600 | 18_300 |
| просмотр уведомлений | 48.8М * 1.5 / 86_400 | 847 | 0.35 * 48.8М * 1.5 / 3600 | 27450 |

## Список источников:
[^1]: [Traffic Analysis](https://hypestat.com/info/netflix.com)

[^2]: [Time Spent Streaming](https://www.statista.com/statistics/1497100/time-spent-streaming-netflix-per-account/)

[^3]: [Library Titles](https://www.whats-on-netflix.com/news/netflix-library-by-the-numbers-2024/)

[^4]: [Traffic Demographics](https://www.similarweb.com/ru/website/netflix.com/#demographics)

[^5]: [Netflix Subscribers](https://www.demandsage.com/netflix-subscribers/)

[^6]: [App MAU](https://www.statista.com/statistics/1251899/netflix-app-monthly-active-users-worldwide/)

[^7]: [Data Used Per Hour](https://help.netflix.com/en/node/87)

[^8]: [Cloud Storage Architecture](https://netflixtechblog.medium.com/netflixs-media-landscape-evolution-from-3-2-1-to-cloud-storage-optimization-77e9a19171ed)