# Проектирование высоконагруженного сервиса Netflix

## Содержание:
1. [Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
2. [Рассчет нагрузки](#2-расчет-нагрузки)

## 1. Тема и целевая аудитория
Netflix - стриминговый сервис для просмотра фильмов и сериалов.

### Функционал MVP
- регистрация и авторизация пользователей
- просмотр фильмов и сериалов в режиме стриминга
- полнотекстовый поиск по названию, жанру, актерам и режиссеру
- добавления фильмов и сериалов в избранное
- история просмотров
- система рекомендаций (общая, по событиям, на основе начатых просмотров, потребленного контента)
- push-уведомления о выходе новых сериалов и серий просмотренных сериалов

### Целевая аудитория

#### Анализ трафика
- количество уникальных пользователей в день (DAU) - 67.5M [^1]
- количество уникальных пользователей в месяц (MAU) - 2B [^1]
- среднее время просмотра стримов в день в первой четверти 2024 (daily time spent streaming) - 2 hours [^2]

 #### Трафик по странам [^3]
- основное географическое положение аудитории - США

![Geography](images/geography.png)

#### Подписчики [^4]
- подписчиков на последнюю четверть 2024 года - 282.7M
- новых подписчиков за 2024 год - 22.7M (282.7M - 260.28M)

## 2. Расчет нагрузки

### Продуктовые метрики
- #### MAU = 271M*
- #### DAU  = 48.8M*
- средняя продолжительность подписки - 4 года [^5]
- размер библиотеки - 19_500**
- соотношение фильмов и сериалов в библиотеке - 70% и 30% соответсвенно [^6]

*В ранее приведенной статистике DAU и MAU учитываются только посещения сайта netflix.com, причем bounce rate, 
т.е. количество пользователей, которые которые покидают сайт после просмотра одной страницы, равно 42.88%.
Следовательно, эти данные не репрезентативны для подсчета выполнения целевых действий. 
За основу расчета DAU и MAU возьму MAU пользователей приложением в 2022 году 106M + 115M = 221M [^7]. 
C 2022 года сервис вырос с 230.7M подписчиков до 282.7M, т.е. на 22.54%.
Если считать, что темпы сервиса за этот период - 22.54%, то за два года MAU увеличилось бы до 271M. 
Нормальный sticky factor для сервисов с видеостримингом - 18%. Расситаем DAU = 0.18 * 271M  = 48.8M.

**В 2022 году библиотека нетфлик составила около 17_000 позиций [^8].<br>
Рассчитаем примерную скорость роста библиотки. Размер библиотеки в US в 2022 году - 6473 [^9], в 2024 году - 7427 [^10]. Т.е. рост на 14.7%.<br>
Тогда на данный момент размер библиотеки равен 17_000 * 1.147 = 19_500.

- #### зарегистрированных пользователей - 2B
Нет точной статистики относительного общего количества пользователей, зарегистрированных на Netflix, но можно допустить, 
что общее количество зарегистрированных пользователей за все время, о которых хранятся данные, сравнимо с MAU, т.е. составляет 2B пользователей.

- #### средний размер хранилища пользователя
| Тип данных | Размер единицы данных | Количество данных на пользователя | Суммарный размер данных |
| ---------- | ----------------------------- | --------------------------------- | ----------------------- |
| Данные о профиле (логин, email, хэш пароля) | 1 КБ | 1 | 1 КБ |
| Избранное | 0.1 КБ (ID контента) КБ | 50 | 5 КБ |
| История просмотров | 0.2 КБ (ID контента + timestamp) КБ | 3310* | 662 КБ |
| Рекомендации | 30 КБ (векторы рекомендаций) | 1 | 30 КБ |
| Push-уведомления | 0.5 КБ | 30 | 15 КБ |

Итого: 1 + 5 + 30 + 662 + 15 = 713 КБ 

*Из рассчета, что в библиотеке соотношение фильмов и сериалов - 70% и 30% соответсвенно, если пользователь в среднем смотрит в день 120 минут контента,
то 84 минут приходится на сериалы и 36 минут на фильмы. Тогда в день пользователь успевает посмотреть в день 84 / 45 = 1.867 серий и 36 / 90 = 0.4 фильма.
Средняя продолжительность подписки составляет 4 года. То есть пользователь успеет посмотреть 1.867 * 365 * 4 = 2726 серий и 0.4 * 365 * 4 = 584 фильма. 
Итого в истории пользователя нужно хранить 2726 + 584 = 3310 позиций.

- #### среднее количество действий пользователя по типам в день

| Наименование действия | Расчет количества действий в день | Результат |
| --- | --- | --- |
| регистрация на сайте | Рост подписчиков за год составил 22.7M / 282.7M = 8%, т.е. 0.02% в день | 0.02 |
| просмотр видео | Поскольку пользователи проводят на сайте 2 часа в день, а в среднем контент длится 45 минут, то пользователь успевает сделать 2.6 запроса на просмотр видео | 2.6 |
| поиск | Предположим, что пользователь ищет, что посмотреть раз в два дня (т.к. основной контент - сериалы и пользователь не успеет досмотреть сериал за один день), при этом при поиске используются фильтры - 5 раз. Итого 0.5 * 5 = 2.5 | 2.5 |
| просмотр страницы фильма или сериала | Пользователи, скорее всего, при каждом действии поиска заходят хотя бы 2 раза посмотреть, что выдал поиск, а также могут открывать страницы фильмов и сериалов на главной странице. Итого примерно 7 действий | 7 |
| просмотр избранного | Редкое действие, примерно раз в неделю | 0.1 |
| обращение к истории просмотров | Считаем, что история являеся базовой функцией и 100% пользователей ее используют | 1 |
| просмотр уведомлений | За два часа пользователь не успеет посмотреть много уведомлений, но за день посещения в ему должно прийти хотя бы одно уведомление | 1.5 |

### Технические метрики

- #### Размер хранения

<ins>**Типы хранимых файлов**</ins><br>
***Видео***<br>
В облачных хранилищах нетфликс хранятся типа видео: *оригинальное видео* и *закодированные видео* (для быстрой отдачи контента разного качества)<br>
Есть два основных типа контента: фильмы и сериалы. Соотношение фильмов и сериалов - 70% и 30% соответсвенно. 
Т.е. количество фильмов - 0.7 * 19_500 = 13_650, сериалов - 0.3 * 19_500 = 5_850.<br>
Средняя продолжительность фильма - 90 мин = 1.5 ч.
Средняя продолжительность серии - 45 мин, среднее количество серий в сериале - 16 [^11], средняя общая продолжительность - 45 мин * 16 = 720 мин = 12 ч

***Данные, связанный со страницей фильма или сериала***<br>
| Тип данных | Размер единицы данных | Количество данных на позицию | Суммарный размер данных |
| ---------- | ----------------------------- | --------------------------------- | ----------------------- |
| Картинка | 300 Кб | 1 | 300 Кб |
| Трейлер | 300_000 Кб | 1 | 300_000 Кб |
| Описание | 1 Кб | 1 | 1 Кб |
| Фото актеров | 100 Кб | 10 | 10_000 Кб |

Итого: 300 + 300_000 + 1 + 10_000 = 310_301 Кб

Общее количество актеров для подсчета размера в хранилище = 56_438 [^12]

<ins>**Размер единицы контента закодированного видео**</ins><br>
| Качество | Размер часа контента в Гб [^13] | Процент от общего контента |
| --- | --- | --- |
| Low | 0.3 Гб | 5% |
| Medium | 0.7 Гб | 15% |
| SD | 1 Гб | 10% |
| HD | 3 Гб | 50%* |
| Ultra HD | 7 Гб| 20%** |

*наиболее популярно в мире<br>
**наиболее популярно в США

<ins>**Размер единицы контента оригинального видео**</ins><br>
Если считать, что кодеки сжимают видео в 50 раз, то размер часа исходного файла составляет 7 Гб * 50 = 350 Гб.
Каждый такой оригинальный файл хранится в 3 экземплярах [^14].


<ins>**Размер хранения оригинальных фильмов**</ins>
| Размер часа | Продолжительность единицы контента (1 фильм) | Количество единиц | Размер в Тб |
| --- | --- | --- | --- |
| 350 Гб | 1.5 ч | 13_650 * 3 | 20_994 Тб |

<ins>**Размер хранения оригинальных сериалов**</ins>
| Размер часа | Продолжительность единицы контента (1 сериал) | Количество единиц | Размер в Тб |
| --- | --- | --- | --- |
| 350 Гб | 12 ч | 5_850 * 3 | 71_982 Тб |

<ins>**Размер хранения закодированных фильмов**</ins>
| Качество | Размер часа | Продолжительность единицы контента (1 фильм) | Количество единиц | Размер в Гб |
| --- | --- | --- | --- | --- |
| Low | 0.3 Гб |  1.5 ч | 682.5 | 307.13 Гб |
| Medium | 0.7 Гб |  1.5 ч | 2047.5 | 2149.88 Гб |
| SD | 1 Гб |  1.5 ч | 1365 | 2047.50 Гб |
| HD | 3 Гб |  1.5 ч | 6825 | 30_712.50 Гб |
| Ultra HD | 7 Гб |  1.5 ч | 2730 | 28_665.00 Гб |

Итого: 307.13 + 2149.88 + 2047.50 + 30_712.50 + 28_665.00 = 63882.01 Гб = 62.38 Тб

<ins>**Размер хранения закодированных сериалов**</ins>
| Качество | Размер часа | Продолжительность единицы контента (1 сериал) | Количество единиц | Размер в Гб |
| --- | --- | --- | --- | --- |
| Low | 0.3 Гб |  12 ч | 292.5 | 1053 Гб |
| Medium | 0.7 Гб |  12 ч | 877.5 | 7371 Гб |
| SD | 1 Гб |  12 ч | 585 | 7020 Гб |
| HD | 3 Гб |  12 ч | 2925 | 105_300 Гб |
| Ultra HD | 7 Гб |  12 ч | 1170 | 98_280 Гб |

Итого: 1053 + 7371 + 7020 + 105_300 + 98_280 = 219024 Гб = 213.89 Тб

<ins>**Размер хранения пользовательских данных**</ins>
| Размер единицы | Количество единиц | Размер в Тб |
| --- | --- | --- |
| 713 Кб | 2B | 1_328 Тб |

<ins>**Размер хранения данных, связанных со страницей фильма или сериала**</ins>
| Тип данных | Размер единицы данных | Количество данных | Суммарный размер данных |
| ---------- | --------------------- | ----------------- | ----------------------- |
| Картинка | 300 Кб | 19_500 | 5707 Mб |
| Трейлер | 300_000 Кб | 19_500 | 5_712_891 Mб |
| Описание | 1 Кб | 19_500 | 19 Mб |
| Фото актеров | 100 Кб | 56_438 | 5511 Mб |

Итого: 5707 + 5_712_891 + 19 + 5511 = 5_724_128 Mб = 5 Тб

**Итого: 20_994 + 71_982 + 62.38 + 213.89 + 1_328 + 5 = 94_585 Тб = 92 Пб**


- #### Сетевой трафик
Prime time для просмoтора ТV-шоу в среднем приходится на промежуток 20.00 - 23.00, то есть чтобы определить пиковую нагрузку нужно посмотреть, у каких стран с наибольшим количеством зрителей может пересечься prime-time (разница во времени в странах составляем менее 3-х часов). Это США, Канада и Бразилия, т.е. примерно 30% всех пользователей. Если считать, что в течение 3-х часов prime time нашрузка распледеляется равномерно, то можно считать, что в пиковый час нагрузки сервисом совершаются 10% действий.<br>
Тогда <br> 
0.1 * DAU * количество действий в день - количество действий в пиковый час.<br>
0.1 * суммарный суточный трафик / 3600 * 8 - пиковое потребление в течение суток


| Наименование действия | Расчет суммарного суточного трафика | Суммарный суточный трафик | Пиковое потребление в течение суток |
| --- | --- | --- | --- |
| регистрация на сайте | 48.8M * 0.02 * 1Кб / (1024 * 1024) | 1 Гбайт/сутки | 0.0002 Гбит/сек |
| просмотр видео в формате Low | (48.8М * 0.05) * 2.6 * (0.3 Гб * 0.75) | 1_427_400 Гбайт/сутки | 317.2 Гбит/сек |
| просмотр видео в формате Medium | (48.8М * 0.15) * 2.6 * (0.7 Гб * 0.75) | 9_991_800 Гбайт/сутки | 2220.4 Гбит/сек |
| просмотр видео в формате SD | (48.8М * 0.1) * 2.6 * (1 Гб * 0.75) | 9_516_000 Гбайт/сутки | 2114.7 Гбит/сек |
| просмотр видео в формате HD | (48.8М * 0.5) * 2.6 * (3 Гб * 0.75) | 142_740_000 Гбайт/сутки | 31_720.0 Гбит/сек |
| просмотр видео в формате Ultra HD | (48.8М * 0.2) * 2.6 * (7 Гб * 0.75) | 133_224_000 Гбайт/сутки | 29_605.3 Гбит/сек |
| поиск | 48.8М * 2.5 * 1024 Кб / (1024 * 1024) | 119_140 Гбайт/сутки | 26.5 Гбит/сек |
| просмотр страницы фильма или сериала | 48.8M * 7 * 310_301 Кб / (1024 * 1024) | 101_088_353 Гбайт/сутки | 22_464.1 Гбит/сек |
| обращение к истории просмотров | 48.8М * 1 * 662 Кб / (1024 * 1024) | 30_809 Гбайт/сутки | 6.8 Гбит/сек |
| просмотр уведомлений | 48.8М * 1.5 * 15 КБ / (1024 * 1024) | 1047 Гбайт/сутки | 0.2 Гбит/сек |

*одно действие - просмотр 45 минут, т.е. 75% от часа

Итого:<br>
Сумарный суточный трафик = 1 + 1_427_400 + 9_991_800 + 9_516_000 + 142_740_000 + 133_224_000 + 119_140 + 101_088_353 + 30_809 + 1047 = 398_138_550 Гбайт/сутки<br>
Пиковое потребление в течение суток = 0.0002 + 317.2 + 2220.4 + 2114.7 + 31720.0 + 29_605.3 + 26.5 + 22_464.1 + 6.8 + 0.2 = 88_475 Гбит/сек

- #### RPS в разбивке по типам запросов 
DAU * количество действий в день / 86_400 - средний RPS<br>
0.1 * DAU * количество действий в день / 3600 - пиковый RPS

| Наименование действия | Расчет среднего RPS | Средний RPS | Расчет пикового RPS | Пиковый RPS |
| --- | --- | --- | --- | --- |
| регистрация на сайте | 48.8M * 0.02 / 86_400 | 11 | 0.1 * 48.8M * 0.02 / 3600 | 27 |
| просмотр видео в формате Low | (48.8М * 0.05) * 2.6 / 86_400 | 73 | (0.1 * 48.8М * 0.05) * 2.6 / 3600  | 176 |
| просмотр видео в формате Medium | (48.8М * 0.15) * 2.6 / 86_400 | 220 | (0.1 * 48.8М * 0.15) * 2.6 / 3600 | 529 |
| просмотр видео в формате SD | (48.8М * 0.1) * 2.6 / 86_400 | 147 | (0.1 * 48.8М * 0.1) * 2.6 / 3600 | 352 |
| просмотр видео в формате HD | (48.8М * 0.5) * 2.6 / 86_400 | 734 | (0.1 * 48.8М * 0.5) * 2.6 / 3600 | 1762 |
| просмотр видео в формате Ultra HD | (48.8М * 0.2) * 2.6 / 86_400 | 294 | (0.1 * 48.8М * 0.2) * 2.6 / 3600 | 705 |
| поиск | 48.8М * 2.5 / 86_400 | 1412 | 0.1 * 48.8М * 2.5 / 3600 | 3389 |
| просмотр страницы фильма или сериала | 48.8M * 7 / 86_400 | 3954 | 0.1 * 48.8M * 7 / 3600 | 9489 |
| обращение к истории просмотров | 48.8М * 1 / 86_400 | 565 | 0.1 * 48.8М * 1 / 3600 | 1356 |
| просмотр уведомлений | 48.8М * 1.5 / 86_400 | 847 | 0.1 * 48.8М * 1.5 / 3600 | 2033 |

## Список источников:
[^1]: [Traffic Analysis](https://hypestat.com/info/netflix.com)

[^2]: [Time Spent Streaming](https://www.statista.com/statistics/1497100/time-spent-streaming-netflix-per-account/)

[^3]: [Traffic Demographics](https://www.similarweb.com/ru/website/netflix.com/#demographics)

[^4]: [Netflix Subscribers](https://www.demandsage.com/netflix-subscribers/)

[^5]: [Average Subscription Duration](https://www.tvtechnology.com/news/streaming-stickiness-netflix-and-prime-video-have-longest-subscription-durations)

[^6]: [Films And TV Shows Statistics](https://www.kaggle.com/datasets/shivamb/netflix-shows)

[^7]: [App MAU](https://www.statista.com/statistics/1251899/netflix-app-monthly-active-users-worldwide/)

[^8]: [Library Size](https://www.comparitech.com/blog/vpn-privacy/netflix-statistics-facts-figures/#:~:text=Netflix%20has%20over%2017%2C000%20titles,libraries%20as%20of%20October%202022)

[^9]: [Library Size In The US 2022](https://www.whats-on-netflix.com/news/netflix-library-by-the-numbers-2022/)

[^10]: [Library Size In The US 2024](https://www.whats-on-netflix.com/news/netflix-library-by-the-numbers-2024/)

[^11]: [Serials Statistics](https://thetechy.life/how-many-seasons-is-it/)

[^12]: [Actors Statistics](https://www.kaggle.com/datasets/dgoenrique/netflix-movies-and-tv-shows)

[^13]: [Data Used Per Hour](https://help.netflix.com/en/node/87)

[^14]: [Cloud Storage Architecture](https://netflixtechblog.medium.com/netflixs-media-landscape-evolution-from-3-2-1-to-cloud-storage-optimization-77e9a19171ed)
