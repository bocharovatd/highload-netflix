# Проектирование высоконагруженного сервиса Netflix

## Содержание:
1. [Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
2. [Рассчет нагрузки](#2-расчет-нагрузки)

## 1. Тема и целевая аудитория
Netflix - стриминговый сервис для просмотра фильмов и сериалов.

### Функционал MVP
- регистрация и авторизация пользователей
- просмотр фильмов и сериалов в режиме стриминга
- полнотекстовый поиск по названию, жанру, актерам и режиссеру
- добавления фильмов и сериалов в избранное
- история просмотров
- система рекомендаций (общая, по событиям, на основе начатых просмотров, потребленного контента)
- push-уведомления о выходе новых сериалов и серий просмотренных сериалов

### Целевая аудитория

#### Анализ трафика
- количество уникальных пользователей в день (DAU) - 67.5M [^1]
- количество уникальных пользователей в месяц (MAU) - 2B [^1]
- среднее время просмотра стримов в день в первой четверти 2024 (daily time spent streaming) - 2 hours [^2]

 #### Трафик по странам [^3]
- основное географическое положение аудитории - США

![Geography](images/geography.png)

#### Подписчики [^4]
- подписчиков на последнюю четверть 2024 года - 282.7M
- новых подписчиков за 2024 год - 22.7M (282.7M - 260.28M)

## 2. Расчет нагрузки

### Продуктовые метрики
- #### MAU = 270.8M*
- #### DAU  = 91.8M*
- средняя продолжительность подписки - 4 года [^5]
- размер библиотеки - 19_500**
- соотношение фильмов и сериалов в библиотеке - 70% и 30% соответсвенно [^6]
- 85% потребляемого пользователями в США контента - это сериалы [^7]

*В ранее приведенной статистике DAU и MAU учитываются только посещения сайта netflix.com, причем bounce rate, 
т.е. количество пользователей, которые которые покидают сайт после просмотра одной страницы, равно 42.88%.
Следовательно, эти данные не репрезентативны для подсчета выполнения целевых действий. 
За основу расчета DAU и MAU возьму MAU пользователей приложением в 2022 году 106M + 115M = 221M [^8]. 
Рассчитаем коэффициент активности пользователей, имеющих подписку. 
В 2022 подписку на Netflix имели 230.7M человек [^4], что составляет 221M / 230.7M * 100% = 95.8% от MAU.
Если предположить, что коэффициент активности пользователей не измелился, учитывая, 
что в 2024 году количество подписчиков составило 282.7M, MAU можно рассчитать как 282.7M * 0.958 = 270.8M.<br>
Чтобы рассчитать sticky factor рассмотрим статистику использования онлайн кинотеатров. 
28% клиентов онлайн-кинотеатров пользуются ими два-три раза в неделю,
27% респондентов заходят в онлайн-кинотеатр несколько раз в месяц, 25% — два раза в месяц, 19% — почти каждый день [^9].
Тогда в среднем пользователи используют онлайн-кинотеатры 3 * 0.28 + 1 * 0.27 + 0.5 * 0.25 + 6 * 0.19 = 2.375 раз в неделю.
Sticky фактор для Netflix можно оценить как 2.375 / 7 * 100% = 33.9%
Расситаем DAU = 0.339 * 270.8M  = 91.8M.

**В 2022 году библиотека нетфлик составила около 17_000 позиций [^10].<br>
Рассчитаем примерную скорость роста библиотки. Размер библиотеки в US в 2022 году - 6473 [^11], в 2024 году - 7427 [^12]. Т.е. рост на 14.7%.<br>
Тогда на данный момент размер библиотеки равен 17_000 * 1.147 = 19_500.

- #### зарегистрированных пользователей - 2B
Нет точной статистики относительного общего количества пользователей, зарегистрированных на Netflix, но можно допустить, 
что общее количество зарегистрированных пользователей за все время, о которых хранятся данные, сравнимо с MAU сайта netflix.com, т.е. составляет 2B пользователей.

- #### средний размер хранилища пользователя
| Тип данных | Размер единицы данных | Количество данных на пользователя | Суммарный размер данных |
| ---------- | ----------------------------- | --------------------------------- | ----------------------- |
| Данные о профиле (логин, email, хэш пароля) | 1 КБ | 1 | 1 КБ |
| Избранное | 0.1 КБ (ID контента) КБ | 50 | 5 КБ |
| История просмотров | 0.2 КБ (ID контента + timestamp) КБ | 3310* | 662 КБ |
| Рекомендации | 30 КБ (векторы рекомендаций) | 1 | 30 КБ |
| Push-уведомления | 0.5 КБ | 30 | 15 КБ |

Итого: 1 + 5 + 30 + 662 + 15 = 713 КБ 

*Из расчета, что в библиотеке соотношение фильмов и сериалов - 70% и 30% соответсвенно, если пользователь в среднем смотрит в день 120 минут контента,
то 84 минут приходится на сериалы и 36 минут на фильмы. Тогда в день пользователь успевает посмотреть в день 84 / 45 = 1.867 серий и 36 / 90 = 0.4 фильма.
Средняя продолжительность подписки составляет 4 года. То есть пользователь успеет посмотреть 1.867 * 365 * 4 = 2726 серий и 0.4 * 365 * 4 = 584 фильма. 
Итого в истории пользователя нужно хранить 2726 + 584 = 3310 позиций.

- #### среднее количество действий пользователя по типам в день

| Наименование действия | Расчет количества действий в день | Результат |
| --- | --- | --- |
| регистрация на сайте | Рост подписчиков за год составил 22.7M, т.е. это 22.7M / 365 = 62_192 регистрации в день. Тогда один пользователь регистрируется 62_192 / 91.8M = 0.0007 раз в день | 0.0007 |
| просмотр видео* | Поскольку в среднем просмотр контента составляет 2 часа в день, то пользователь за это время запрашивает 2 * 3600 / 4 = 1800 сегментов | 1800 |
| поиск | Предположим, что пользователь ищет, что посмотреть раз в два дня (т.к. основной контент - сериалы и пользователь не успеет досмотреть сериал за один день), при этом при поиске последовательно применяются фильтры - 5 раз. Итого 0.5 * 5 = 2.5 | 2.5 |
| просмотр страницы фильма или сериала | Пользователи, скорее всего, при каждом действии поиска заходят хотя бы 2 раза посмотреть, что выдал поиск, а также могут открывать страницы фильмов и сериалов на главной странице. Итого примерно 7 действий | 7 |
| просмотр трейлера на странице фильма или сериала | Будем исходить из расчета, что пользователь на каждой пятой открытой странице заходит посмотреть трейлер, т.е. 7 * 0.2 = 1.4 действия | 1.4 |
| просмотр избранного | Редкое действие, примерно раз в неделю | 0.1 |
| обращение к истории просмотров | Предположим, что пользователи чаще всего используют поиск, чтобы продолжить смотреть сериал. С учетом соотношения просмотра фильмов и сериалов, это примерно 0.85 раз в день | 0.85 |
| просмотр уведомлений | За два часа пользователь не успеет посмотреть много уведомлений, но за день посещения в ему должно прийти хотя бы одно уведомление | 1.5 |

*При подсчета количества запросов, которые отправляет пользователь при просмотре видео необходимо учитывать, 
что для раздачи контента Netflix использует протокол DASH, который подразумевает разделение загружаемого контента на сегменты 
и в зависисмости от скорости соединения определяется сегменты какого разрешения будут направляться пользователю. За размер сегмента возьмем 4 сек [^13].

### Технические метрики

- #### Размер хранения

<ins>**Типы хранимых файлов**</ins><br>
***Видео***<br>
В облачных хранилищах нетфликс хранятся типа видео: *оригинальное видео* и *закодированные видео* (для быстрой отдачи контента разного качества)<br>
Есть два основных типа контента: фильмы и сериалы. Соотношение фильмов и сериалов - 70% и 30% соответсвенно. 
Т.е. количество фильмов - 0.7 * 19_500 = 13_650, сериалов - 0.3 * 19_500 = 5_850.<br>
Средняя продолжительность фильма - 90 мин = 1.5 ч.
Средняя продолжительность серии - 45 мин, среднее количество серий в сериале - 16 [^14], средняя общая продолжительность - 45 мин * 16 = 720 мин = 12 ч

***Данные, связанный со страницей фильма или сериала***<br>
| Тип данных | Размер единицы данных | Количество данных на позицию | Суммарный размер данных |
| ---------- | ----------------------------- | --------------------------------- | ----------------------- |
| Картинка | 300 Кб | 1 | 300 Кб |
| Трейлер | 300_000 Кб | 1 | 300_000 Кб |
| Описание | 1 Кб | 1 | 1 Кб |
| Фото актеров | 100 Кб | 10 | 10_000 Кб |

Итого: 300 + 300_000 + 1 + 10_000 = 310_301 Кб*

*без трейлера: 300 + 1 + 10_000 = 10_301 Кб

Общее количество актеров для подсчета размера в хранилище = 56_438 [^15]

<ins>**Размер единицы контента закодированного видео**</ins><br>
| Качество | Размер часа контента в Гб [^16] | Процент от общего контента | Размер сегмента длительностью 4 cек|
| --- | --- | --- | --- |
| Low | 0.3 Гб | 5% | 349.5 Кб |
| Medium | 0.7 Гб | 15% | 815.6 Кб |
| SD | 1 Гб | 10% | 1165.1 Кб |
| HD | 3 Гб | 50%* | 3495.3 Кб |
| Ultra HD | 7 Гб | 20%** | 8155.5 Кб |

*наиболее популярно в мире<br>
**наиболее популярно в США

<ins>**Размер единицы контента оригинального видео**</ins><br>
Рассчитаем, сколько весит оригинальный RAW видео-файл, который потом кодируется для передачи пользователю.
Одна секунда весит 150Мб, т.е. 150 * 3600 / 1024 = 530Гб весит час видео [^17].
Каждый такой оригинальный файл хранится в 3 экземплярах [^18].


<ins>**Размер хранения оригинальных фильмов**</ins>
| Размер часа | Продолжительность единицы контента (1 фильм) | Количество единиц | Размер в Тб |
| --- | --- | --- | --- |
| 530 Гб | 1.5 ч | 13_650 * 3 | 31_792 Тб |

<ins>**Размер хранения оригинальных сериалов**</ins>
| Размер часа | Продолжительность единицы контента (1 сериал) | Количество единиц | Размер в Тб |
| --- | --- | --- | --- |
| 530 Гб | 12 ч | 5_850 * 3 | 109_002 Тб |

<ins>**Размер хранения закодированных фильмов**</ins>
| Качество | Размер часа | Продолжительность единицы контента (1 фильм) | Количество единиц | Размер в Гб |
| --- | --- | --- | --- | --- |
| Low | 0.3 Гб |  1.5 ч | 682.5 | 307.13 Гб |
| Medium | 0.7 Гб |  1.5 ч | 2047.5 | 2149.88 Гб |
| SD | 1 Гб |  1.5 ч | 1365 | 2047.50 Гб |
| HD | 3 Гб |  1.5 ч | 6825 | 30_712.50 Гб |
| Ultra HD | 7 Гб |  1.5 ч | 2730 | 28_665.00 Гб |

Итого: 307.13 + 2149.88 + 2047.50 + 30_712.50 + 28_665.00 = 63882.01 Гб = 62.38 Тб

<ins>**Размер хранения закодированных сериалов**</ins>
| Качество | Размер часа | Продолжительность единицы контента (1 сериал) | Количество единиц | Размер в Гб |
| --- | --- | --- | --- | --- |
| Low | 0.3 Гб |  12 ч | 292.5 | 1053 Гб |
| Medium | 0.7 Гб |  12 ч | 877.5 | 7371 Гб |
| SD | 1 Гб |  12 ч | 585 | 7020 Гб |
| HD | 3 Гб |  12 ч | 2925 | 105_300 Гб |
| Ultra HD | 7 Гб |  12 ч | 1170 | 98_280 Гб |

Итого: 1053 + 7371 + 7020 + 105_300 + 98_280 = 219024 Гб = 213.89 Тб

<ins>**Размер хранения пользовательских данных**</ins>
| Размер единицы | Количество единиц | Размер в Тб |
| --- | --- | --- |
| 713 Кб | 2B | 1_328 Тб |

<ins>**Размер хранения данных, связанных со страницей фильма или сериала**</ins>
| Тип данных | Размер единицы данных | Количество данных | Суммарный размер данных |
| ---------- | --------------------- | ----------------- | ----------------------- |
| Картинка | 300 Кб | 19_500 | 5707 Mб |
| Трейлер | 300_000 Кб | 19_500 | 5_712_891 Mб |
| Описание | 1 Кб | 19_500 | 19 Mб |
| Фото актеров | 100 Кб | 56_438 | 5511 Mб |

Итого: 5707 + 5_712_891 + 19 + 5511 = 5_724_128 Mб = 5.46 Тб

**Итого: 31_792 + 109_002 + 62.38 + 213.89 + 1_328 + 5.46 = 142_403.73 Тб = 139.07 Пб**


- #### Сетевой трафик
Prime time для просмoтора ТV-шоу в среднем приходится на промежуток 20.00 - 23.00, то есть чтобы определить пиковую нагрузку нужно посмотреть, у каких стран с наибольшим количеством зрителей может пересечься prime-time (разница во времени в странах составляем менее 3-х часов). Это США, Канада и Бразилия, т.е. примерно 30% всех пользователей. Если считать, что в течение 3-х часов prime time нашрузка распледеляется равномерно, то можно считать, что в пиковый час нагрузки сервисом совершаются 10% действий.<br>
Тогда <br> 
0.1 * DAU * количество действий в день - количество действий в пиковый час.<br>
0.1 * суммарный суточный трафик / 3600 * 8 - пиковое потребление в течение суток


| Наименование действия | Расчет суммарного суточного трафика | Суммарный суточный трафик | Пиковое потребление в течение суток |
| --- | --- | --- | --- |
| регистрация на сайте | 91.8M * 0.0007 * 1Кб / (1024 * 1024) | 0.06 Гбайт/сутки | 0.00001 Гбит/сек |
| просмотр видео в формате Low | (91.8M * 0.05) * 1800 * 349.5 Кб / (1024 * 1024) | 2_753_800 Гбайт/сутки | 612.0 Гбит/сек |
| просмотр видео в формате Medium | (91.8M * 0.15) * 1800 * 815.6 Кб / (1024 * 1024) | 19_278_967 Гбайт/сутки | 4284.2 Гбит/сек |
| просмотр видео в формате SD | (91.8M * 0.1) * 1800 * 1165.1 Кб / (1024 * 1024) | 18_360_245 Гбайт/сутки | 4080.1 Гбит/сек |
| просмотр видео в формате HD | (91.8M * 0.5) * 1800 * 3495.3 Кб / (1024 * 1024) | 275_403_677 Гбайт/сутки | 61_200.8 Гбит/сек |
| просмотр видео в формате Ultra HD | (91.8M * 0.2) * 1800 * 8155.5 Кб / (1024 * 1024) | 257_037_128 Гбайт/сутки | 57_119.4 Гбит/сек |
| поиск | 91.8M * 2.5 * 1024 Кб / (1024 * 1024) | 224_121 Гбайт/сутки | 49.8 Гбит/сек |
| просмотр страницы фильма или сериала | 48.8M * 7 * 10_301 Кб / (1024 * 1024) | 6_312_773 Гбайт/сутки | 1402.8 Гбит/сек |
| просмотр трейлера на странице фильма или сериала | 91.8M * 1.4 * 300_000 Кб / (1024 * 1024) | 36_769_867 Гбайт/сутки | 8171.1 Гбит/сек |
| обращение к истории просмотров | 91.8M * 0.85 * 662 Кб / (1024 * 1024) | 49_263 Гбайт/сутки | 10.9 Гбит/сек |
| просмотр уведомлений | 91.8M * 1.5 * 15 Кб / (1024 * 1024) | 1970 Гбайт/сутки | 0.4 Гбит/сек |

Итого:<br>
Сумарный суточный трафик =  0.00001 + 2_753_800 + 19_278_967 + 18_360_245 + 275_403_677 + 257_037_128 + 49.8 + 6_312_773 + 36_769_867 + 49_263 + 1970 = 615_967_739.8 Гбайт/сутки<br>
Пиковое потребление в течение суток = 0.00001 + 612.0 + 4284.2 + 4080.1 + 61_200.8 + 57_119.4 + 49.8 + 1402.8 + 8171.1 + 10.9 + 0.4 = 136_931.5 Гбит/сек

- #### RPS в разбивке по типам запросов 
DAU * количество действий в день / 86_400 - средний RPS<br>
0.1 * DAU * количество действий в день / 3600 - пиковый RPS

| Наименование действия | Расчет среднего RPS | Средний RPS | Расчет пикового RPS | Пиковый RPS |
| --- | --- | --- | --- | --- |
| регистрация на сайте | 91.8M  * 0.0007 / 86_400 | 1 | 0.1 * 91.8M * 0.0007 / 3600 | 2 |
| просмотр видео в формате Low | (91.8M * 0.05) * 1800 / 86_400 | 95_625 | (0.1 * 91.8M * 0.05) * 1800 / 3600  | 229_500 |
| просмотр видео в формате Medium | (91.8M * 0.15) * 1800 / 86_400 | 286_875 | (0.1 * 91.8M * 0.15) * 1800 / 3600 | 688_500 |
| просмотр видео в формате SD | (91.8M * 0.1) * 1800 / 86_400 | 191_250 | (0.1 * 91.8M * 0.1) * 1800 / 3600 | 459_000 |
| просмотр видео в формате HD | (91.8M * 0.5) * 1800 / 86_400 | 956_250 | (0.1 * 91.8M * 0.5) * 1800 / 3600 | 2_295_000 |
| просмотр видео в формате Ultra HD | (91.8M * 0.2) * 1800 / 86_400 | 382_500 | (0.1 * 91.8M * 0.2) * 1800 / 3600 | 918_000 |
| поиск | 91.8M * 2.5 / 86_400 | 2656 | 0.1 * 91.8M * 2.5 / 3600 | 6375 |
| просмотр страницы фильма или сериала | 91.8M * 7 / 86_400 | 7438 | 0.1 * 91.8M * 7 / 3600 | 17_850 |
| просмотр трейлера на странице фильма или сериала |  91.8M * 1.4 / 86_400 | 1487 | 0.1 * 91.8M * 1.4 / 3600 | 3570 |
| обращение к истории просмотров | 91.8M * 0.85 / 86_400 | 903 | 0.1 * 91.8M * 1 / 3600 | 2550 |
| просмотр уведомлений | 91.8M * 1.5 / 86_400 | 1594 | 0.1 * 91.8M * 1.5 / 3600 | 3825 |

## Список источников:
[^1]: [Traffic Analysis](https://hypestat.com/info/netflix.com)

[^2]: [Time Spent Streaming](https://www.statista.com/statistics/1497100/time-spent-streaming-netflix-per-account/)

[^3]: [Traffic Demographics](https://www.similarweb.com/ru/website/netflix.com/#demographics)

[^4]: [Netflix Subscribers](https://www.demandsage.com/netflix-subscribers/)

[^5]: [Average Subscription Duration](https://www.tvtechnology.com/news/streaming-stickiness-netflix-and-prime-video-have-longest-subscription-durations)

[^6]: [Films And TV Shows Statistics](https://www.kaggle.com/datasets/shivamb/netflix-shows)

[^7]: [TV Series Watching Statistics](https://www.comparitech.com/blog/vpn-privacy/netflix-statistics-facts-figures/#:~:text=The%20average%20Netflix%20user%20has%20watched%2062%20days%E2%80%99%20worth%20of%20TV%20shows%20and%20movies%20since%20creating%20an%20account)

[^8]: [App MAU](https://www.statista.com/statistics/1251899/netflix-app-monthly-active-users-worldwide/)

[^9]: [How Often People Watch Online Movie Theater](https://www.rbc.ru/rbcfreenews/620d4eeb9a794734587b6ebe)

[^10]: [Library Size](https://www.comparitech.com/blog/vpn-privacy/netflix-statistics-facts-figures/#:~:text=Netflix%20has%20over%2017%2C000%20titles,libraries%20as%20of%20October%202022)

[^11]: [Library Size In The US 2022](https://www.whats-on-netflix.com/news/netflix-library-by-the-numbers-2022/)

[^12]: [Library Size In The US 2024](https://www.whats-on-netflix.com/news/netflix-library-by-the-numbers-2024/)

[^13]: [DASH Segment Size](https://bitmovin.com/blog/mpeg-dash-hls-segment-length/)

[^14]: [Serials Statistics](https://thetechy.life/how-many-seasons-is-it/)

[^15]: [Actors Statistics](https://www.kaggle.com/datasets/dgoenrique/netflix-movies-and-tv-shows)

[^16]: [Data Used Per Hour](https://help.netflix.com/en/node/87)

[^17]: [RAW Video File Size](https://www.broadcastbeat.com/what-is-raw-video-and-why-its-needed/)

[^18]: [Cloud Storage Architecture](https://netflixtechblog.medium.com/netflixs-media-landscape-evolution-from-3-2-1-to-cloud-storage-optimization-77e9a19171ed)
